<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
</head>

<body>
    <style>
        #disconnect {
            position: fixed;
            background-color: red;
            color: white;
            padding: 1em;
            font-weight: bold;
            height: 4em;
            width: 100%;
            top: 0px;
            left: 0px;
        }

        #load {
            display: none;
        }

        #preload {
            width: 0px;
            height: 0px;
            display: inline;
            background-image: url('resources/error.jpg');
        }
    </style>

    <h1>Upload Page</h1>
    <p>Note: This page only works for modern browsers, which IE is not included.</p>
    <p>I know it is ugly, but no time for styling! I still have to watch anime!</p>
    <p>
        <a href="/uploaded">List of uploaded files</a>. <br />
        Note that all files are treated as html, with a random ID. <br />
        Actually the ID is not random, it is the server starting timestamp + counter. <br />
        Currently I can only write the upload function, I have to wait for the actual HTML to write the parser.
    </p>
    <p id="caption">
        Drop the file below:
    </p>
    <img src="resources/waiting.jpg" id="dropContainer"></div>
    <img src="resources/finished.jpg" style="display: none;" id="finished">
    <img src="resources/error.jpg" style="display: none;" id="error">
    <div id="preload"></div><br />
    <div id="disconnect" style="display: none; ">WebSocket Disconnected! Your recent changes are probably lost!</div>

    <template>
        <li>
            <p></p>
            <input type="text" onkeypress="keypress(event)">
        </li>
    </template>
    <h2>Questions</h2>
    <p>Add Question:</p>
    <input type="text" onkeypress="addQuestion(event)">
    <ol id="questions"></ol>

    <script>
        const caption = document.getElementById('caption')
        const dropContainer = document.getElementById('dropContainer')
        const disconnected = document.getElementById('disconnect')
        let ws = new WebSocket('ws://localhost:4000')
        let timeout
        let timer = setInterval(() => {
            timeout = setTimeout(() => {
                disconnected.style.display = 'block'
                clearInterval(timer)
            }, 3000)
            ws.send(JSON.stringify({ id: 'ping' }))
        }, 3000)

        ws.onmessage = msg => {
            const data = JSON.parse(msg.data)
            switch (data.id) {
                case 'pong':
                    clearTimeout(timeout)
                    break
                default:
                    console.log(data)
                    break
            }
        }

        function addQuestion(evt) {
            // I know this is deprecated, but this is the simplest
            if (evt.keyCode == 13)
                ws.send(JSON.stringify({ id: 'add', content: event.target.value}))
        }

        function load(file) {
            let fileReader = new FileReader()
            fileReader.onload = evt => {
                let xhttp = new XMLHttpRequest()
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        if (this.status == 200) {
                            caption.textContent = 'Finished!'
                            dropContainer.style.display = 'none'
                            document.getElementById('finished').style.display = 'block'
                        }
                        else {
                            caption.textContent =
                                `Error Occurred! Status: ${this.status}\nPlease ask in the group and try again!`
                            dropContainer.style.display = 'none'
                            document.getElementById('error').style.display = 'block'
                        }
                    }
                }
                xhttp.ontimeout = () => dropContainer.textContent = 'Error! Connection Timeout!'
                xhttp.open('POST', 'upload', true)
                xhttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8')
                xhttp.send(JSON.stringify({ content: evt.target.result }))
            }
            fileReader.readAsText(file)
        }

        dropContainer.ondragover = dropContainer.ondragenter = evt => evt.preventDefault()
        dropContainer.ondrop = evt => {
            dropContainer.textContent = 'Now Loading!!!'
            load(evt.dataTransfer.files[0])
            evt.preventDefault()
        }

    </script>
</body>

</html>